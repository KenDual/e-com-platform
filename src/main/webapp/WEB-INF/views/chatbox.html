<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>AI Chatbox</title>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Chat bubble basic */
        .msg { padding: .6rem .8rem; border-radius: .75rem; margin-bottom: .5rem; max-width: 85%; }
        .msg.me { background: #e7f1ff; align-self: flex-end; }
        .msg.bot { background: #f5f5f5; align-self: flex-start; }
        .chat-scroll { height: 65vh; overflow-y: auto; }
        .product-scroll { height: 65vh; overflow-y: auto; }

        /* Ban đầu full width; khi có result -> thêm .split để lộ cột phải */
        .col-left.full { width: 100%; }
        .col-left.split { width: 50%; }
        .col-right { display: none; }
        .col-right.show { display: block; }

        /* 16:9 vùng top (search box zone) */
        .hero-169 { aspect-ratio: 16 / 9; background: #0d6efd10; border-radius: 1rem; display: flex; align-items: center; justify-content: center; }

        @media (max-width: 992px) {
            .col-left.split, .col-right.show { width: 100%; }
        }
    </style>
</head>
<body class="bg-light">
<div class="container py-4">

    <!-- Thanh tiêu đề -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="m-0">Chat với AI tư vấn laptop</h3>
        <a th:href="@{/}" class="btn btn-outline-secondary btn-sm">Trang chủ</a>
    </div>

    <!-- Vùng hero 16:9 chỉ để tạo cảm giác khung lớn ban đầu -->
    <div id="hero" class="hero-169 mb-3">
        <div class="text-center w-100 px-3">
            <div class="input-group input-group-lg mx-auto" style="max-width: 900px;">
                <input id="q" type="text" class="form-control" placeholder="Ví dụ: laptop mỏng nhẹ gõ code, pin 8h, ~20–25 triệu">
                <button id="btnSend" class="btn btn-primary">Hỏi AI</button>
            </div>
            <small class="text-muted">Gõ yêu cầu về laptop. Sau khi có kết quả, màn hình sẽ tự chia 2 cột.</small>
        </div>
    </div>

    <!-- Vùng nội dung: sẽ split thành 2 cột khi có kết quả -->
    <div class="d-lg-flex gap-3">
        <!-- Cột trái: Chat -->
        <div id="leftCol" class="col-left full">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <strong>Dialog</strong>
                </div>
                <div id="chat" class="card-body d-flex flex-column chat-scroll">
                    <!-- Tin nhắn sẽ được append bằng JS -->
                </div>
                <div class="card-footer bg-white">
                    <div class="input-group">
                        <input id="q2" type="text" class="form-control" placeholder="Tiếp tục hỏi...">
                        <button id="btnSend2" class="btn btn-primary">Gửi</button>
                    </div>
                    <small class="text-muted">Enter to send</small>
                </div>
            </div>
        </div>

        <!-- Cột phải: Sản phẩm -->
        <div id="rightCol" class="col-right">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <strong>Kết quả sản phẩm</strong>
                    <span id="count" class="badge text-bg-secondary">0</span>
                </div>
                <div id="products" class="card-body product-scroll">
                    <!-- Card sản phẩm sẽ render ở đây -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JS: dùng Thymeleaf để build URL đúng context -->
<script th:inline="javascript">
    // Thymeleaf sẽ render đúng context path, VD: /Ecom_war/api/chat
    const API_CHAT = /*[[@{/api/chat}]]*/ '/api/chat';
    const PRODUCT_URL_PREFIX = /*[[@{/product}]]*/ '/product';

    (function () {
        const qMain = document.getElementById('q');
        const qAlt  = document.getElementById('q2');
        const btn1  = document.getElementById('btnSend');
        const btn2  = document.getElementById('btnSend2');
        const chat  = document.getElementById('chat');
        const hero  = document.getElementById('hero');
        const left  = document.getElementById('leftCol');
        const right = document.getElementById('rightCol');
        const productsDiv = document.getElementById('products');
        const countBadge  = document.getElementById('count');

        function appendMsg(text, who) {
            const div = document.createElement('div');
            div.className = 'msg ' + (who === 'me' ? 'me ms-auto' : 'bot me-2');
            div.textContent = text;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function priceFmt(vnd) {
            if (vnd == null) return '—';
            try { return Number(vnd).toLocaleString('vi-VN') + ' ₫'; }
            catch { return vnd + ' ₫'; }
        }

        function renderProducts(list) {
            productsDiv.innerHTML = '';
            (list || []).forEach(p => {
                const card = document.createElement('div');
                card.className = 'card mb-3';

                const imgSrc = p.image ? p.image : 'https://placehold.co/600x400?text=No+Image';
                const desc = p.description ? p.description : '—';
                const detailHref = `${PRODUCT_URL_PREFIX}?id=${encodeURIComponent(p.id ?? '')}`;

                card.innerHTML = `
                <div class="row g-0">
                   <div class="col-md-4">
                     <img src="${imgSrc}" class="img-fluid rounded-start" alt="${p.name || ''}">
                   </div>
                   <div class="col-md-8">
                     <div class="card-body">
                       <h5 class="card-title mb-1">${p.name || 'Sản phẩm'}</h5>
                       <div class="text-muted small mb-2">${p.company || ''}</div>
                       <div class="mb-2"><strong>${priceFmt(p.priceVnd)}</strong></div>
                       ${p.specs ? `<div class="small mb-2"><code>${p.specs}</code></div>` : ''}
                       <p class="card-text">${desc}</p>
                       <a class="btn btn-sm btn-primary" href="${detailHref}">Xem chi tiết</a>
                     </div>
                   </div>
                </div>
            `;
                productsDiv.appendChild(card);
            });
            countBadge.textContent = (list || []).length;
        }

        async function sendQuery(q) {
            if (!q || !q.trim()) return;
            appendMsg(q, 'me');

            // trạng thái loading
            const loading = document.createElement('div');
            loading.className = 'msg bot';
            loading.textContent = 'Looking for suitable products...';
            chat.appendChild(loading);
            chat.scrollTop = chat.scrollHeight;

            try {
                const url = `${API_CHAT}?q=${encodeURIComponent(q)}`;
                const res = await fetch(url, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const data = await res.json();

                // remove loading
                chat.removeChild(loading);

                // hiển thị answer
                if (data.answer) appendMsg(data.answer, 'bot');

                // Nếu có sản phẩm -> chuyển layout sang 2 cột
                if (Array.isArray(data.products) && data.products.length > 0) {
                    hero.style.display = 'none';
                    left.classList.remove('full'); left.classList.add('split');
                    right.classList.add('show');
                    renderProducts(data.products);
                }
            } catch (e) {
                if (loading.parentNode) chat.removeChild(loading);
                appendMsg('Xin lỗi, hệ thống đang bận. Vui lòng thử lại sau.', 'bot');
                console.error(e);
            }
        }

        btn1.addEventListener('click', () => sendQuery(qMain.value));
        btn2.addEventListener('click', () => sendQuery(qAlt.value));
        qMain.addEventListener('keydown', e => { if (e.key === 'Enter') sendQuery(qMain.value); });
        qAlt.addEventListener('keydown',  e => { if (e.key === 'Enter') sendQuery(qAlt.value); });
    })();
</script>
</body>
</html>
